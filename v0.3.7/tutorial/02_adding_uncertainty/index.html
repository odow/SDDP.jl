<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Basic II: adding uncertainty · SDDP.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="SDDP.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit">SDDP.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../01_first_steps/">Basic I: first steps</a></li><li class="is-active"><a class="tocitem" href>Basic II: adding uncertainty</a><ul class="internal"><li><a class="tocitem" href="#Creating-a-model"><span>Creating a model</span></a></li><li><a class="tocitem" href="#Training-and-simulating-the-policy"><span>Training and simulating the policy</span></a></li></ul></li><li><a class="tocitem" href="../03_objective_uncertainty/">Basic III: objective uncertainty</a></li><li><a class="tocitem" href="../04_markov_uncertainty/">Basic IV: Markov uncertainty</a></li><li><a class="tocitem" href="../05_plotting/">Basic V: plotting</a></li><li><a class="tocitem" href="../06_warnings/">Basic VI: words of warning</a></li><li><a class="tocitem" href="../11_objective_states/">Advanced I: objective states</a></li><li><a class="tocitem" href="../12_belief_states/">Advanced II: belief states</a></li><li><a class="tocitem" href="../13_integrality/">Advanced III: integrality</a></li><li><a class="tocitem" href="../21_theory_intro/">Theory I: an intro to SDDP</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">How-to guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../guides/add_a_multidimensional_state_variable/">Add a multi-dimensional state variable</a></li><li><a class="tocitem" href="../../guides/add_a_risk_measure/">Add a risk measure</a></li><li><a class="tocitem" href="../../guides/add_multidimensional_noise_Terms/">Add multi-dimensional noise terms</a></li><li><a class="tocitem" href="../../guides/add_noise_in_the_constraint_matrix/">Add noise in the constraint matrix</a></li><li><a class="tocitem" href="../../guides/choose_a_stopping_rule/">Choose a stopping rule</a></li><li><a class="tocitem" href="../../guides/create_a_general_policy_graph/">Create a general policy graph</a></li><li><a class="tocitem" href="../../guides/debug_a_model/">Debug a model</a></li><li><a class="tocitem" href="../../guides/improve_computational_performance/">Improve computational performance</a></li><li><a class="tocitem" href="../../guides/simulate_using_a_different_sampling_scheme/">Simulate using a different sampling scheme</a></li><li><a class="tocitem" href="../../guides/upgrade_from_the_old_sddp/">Upgrade from the old SDDP.jl</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/FAST_hydro_thermal/">FAST: the hydro-thermal problem</a></li><li><a class="tocitem" href="../../examples/FAST_production_management/">FAST: the production management problem</a></li><li><a class="tocitem" href="../../examples/FAST_quickstart/">FAST: the quickstart problem</a></li><li><a class="tocitem" href="../../examples/Hydro_thermal/">Hydro-thermal scheduling</a></li><li><a class="tocitem" href="../../examples/StochDynamicProgramming.jl_multistock/">StochDynamicProgramming: the multistock problem</a></li><li><a class="tocitem" href="../../examples/StochDynamicProgramming.jl_stock/">StochDynamicProgramming: the stock problem</a></li><li><a class="tocitem" href="../../examples/StructDualDynProg.jl_prob5.2_2stages/">StructDualDynProg: Problem 5.2, 2 stages</a></li><li><a class="tocitem" href="../../examples/StructDualDynProg.jl_prob5.2_3stages/">StructDualDynProg: Problem 5.2, 3 stages</a></li><li><a class="tocitem" href="../../examples/agriculture_mccardle_farm/">The farm planning problem</a></li><li><a class="tocitem" href="../../examples/air_conditioning/">Air conditioning</a></li><li><a class="tocitem" href="../../examples/all_blacks/">Deterministic All Blacks</a></li><li><a class="tocitem" href="../../examples/asset_management_simple/">Asset management</a></li><li><a class="tocitem" href="../../examples/asset_management_stagewise/">Asset management with modifications</a></li><li><a class="tocitem" href="../../examples/belief/">Partially observable inventory management</a></li><li><a class="tocitem" href="../../examples/biobjective_hydro/">Biobjective hydro-thermal</a></li><li><a class="tocitem" href="../../examples/booking_management/">Booking management</a></li><li><a class="tocitem" href="../../examples/generation_expansion/">Generation expansion</a></li><li><a class="tocitem" href="../../examples/hydro_valley/">Hydro valleys</a></li><li><a class="tocitem" href="../../examples/infinite_horizon_hydro_thermal/">Infinite horizon hydro-thermal</a></li><li><a class="tocitem" href="../../examples/infinite_horizon_trivial/">Infinite horizon trivial</a></li><li><a class="tocitem" href="../../examples/no_strong_duality/">No strong duality</a></li><li><a class="tocitem" href="../../examples/objective_state_newsvendor/">Newsvendor</a></li><li><a class="tocitem" href="../../examples/sldp_example_one/">SLDP: example 1</a></li><li><a class="tocitem" href="../../examples/sldp_example_two/">SLDP: example 2</a></li><li><a class="tocitem" href="../../examples/stochastic_all_blacks/">Stochastic All Blacks</a></li><li><a class="tocitem" href="../../examples/the_farmers_problem/">The farmer&#39;s problem</a></li><li><a class="tocitem" href="../../examples/vehicle_location/">Vehicle location</a></li></ul></li><li><a class="tocitem" href="../../apireference/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Basic II: adding uncertainty</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Basic II: adding uncertainty</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/odow/SDDP.jl/blob/master/docs/src/tutorial/02_adding_uncertainty.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Basic-II:-adding-uncertainty"><a class="docs-heading-anchor" href="#Basic-II:-adding-uncertainty">Basic II: adding uncertainty</a><a id="Basic-II:-adding-uncertainty-1"></a><a class="docs-heading-anchor-permalink" href="#Basic-II:-adding-uncertainty" title="Permalink"></a></h1><p>In the previous tutorial, <a href="../01_first_steps/#Basic-I:-first-steps">Basic I: first steps</a>, we created a deterministic hydro-thermal scheduling model. In this tutorial, we extend the problem by adding uncertainty.</p><p>The key development is that we are going to implement a function called <a href="../../apireference/#SDDP.parameterize"><code>SDDP.parameterize</code></a>, which modifies the subproblem based on a realization of the uncertainty <span>$\omega$</span>.</p><p>Notably missing from our previous model were inflows. Inflows are the water that flows into the reservoir through rainfall or rivers. These inflows are uncertain, and are the cause of the main trade-off in hydro-thermal scheduling: the desire to use water now to generate cheap electricity, against the risk that future inflows will be low, leading to blackouts or expensive thermal generation.</p><p>For our simple model, we assume that the inflows can be modelled by a discrete distribution with the three outcomes given in the following table:</p><table><tr><th style="text-align: right">ω</th><th style="text-align: right">0</th><th style="text-align: right">50</th><th style="text-align: right">100</th></tr><tr><td style="text-align: right">P(ω)</td><td style="text-align: right">1/3</td><td style="text-align: right">1/3</td><td style="text-align: right">1/3</td></tr></table><p>The value of the noise (the random variable) is observed by the agent at the start of each stage. This makes the problem a <em>wait-and-see</em> or <em>hazard-decision</em> formulation.</p><p>To represent this, we can draw the following picture. The wavy lines denote the uncertainty arriving into the start of each stage (node).</p><p><img src="../../assets/stochastic_linear_policy_graph.png" alt="Linear policy graph"/></p><p>In addition to adding this uncertainty to the model, we also need to modify the dynamics to include <code>inflow</code>:</p><p><code>volume.out = volume.in + inflow - hydro_generation - hydro_spill</code></p><h2 id="Creating-a-model"><a class="docs-heading-anchor" href="#Creating-a-model">Creating a model</a><a id="Creating-a-model-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-a-model" title="Permalink"></a></h2><p>To add an uncertain variable to the model, we create a new JuMP variable <code>inflow</code>, and then call the function <a href="../../apireference/#SDDP.parameterize"><code>SDDP.parameterize</code></a>. The <a href="../../apireference/#SDDP.parameterize"><code>SDDP.parameterize</code></a> function takes three arguments: the subproblem, a vector of realizations, and a corresponding vector of probabilities.</p><pre><code class="language-julia">using SDDP, GLPK

model = SDDP.LinearPolicyGraph(
    stages = 3,
    sense = :Min,
    lower_bound = 0.0,
    optimizer = GLPK.Optimizer
) do subproblem, t
    # Define the state variable.
    @variable(subproblem, 0 &lt;= volume &lt;= 200, SDDP.State, initial_value = 200)
    # Define the control variables.
    @variables(subproblem, begin
        thermal_generation &gt;= 0
        hydro_generation   &gt;= 0
        hydro_spill        &gt;= 0
        inflow
    end)
    # Define the constraints
    @constraints(subproblem, begin
        volume.out == volume.in + inflow - hydro_generation - hydro_spill
        demand_constraint, thermal_generation + hydro_generation == 150.0
    end)
    # Define the objective for each stage `t`. Note that we can use `t` as an
    # index for t = 1, 2, 3.
    fuel_cost = [50.0, 100.0, 150.0]
    @stageobjective(subproblem, fuel_cost[t] * thermal_generation)
    # Parameterize the subproblem.
    SDDP.parameterize(subproblem, [0.0, 50.0, 100.0], [1/3, 1/3, 1/3]) do ω
        JuMP.fix(inflow, ω)
    end
end</code></pre><pre><code class="language-none">A policy graph with 3 nodes.
 Node indices: 1, 2, 3
</code></pre><p>Note how we use the JuMP function <a href="http://jump.dev/JuMP.jl/v0.21/variables/#JuMP.fix"><code>JuMP.fix</code></a> to set the value of the <code>inflow</code> variable to <code>ω</code>.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p><a href="../../apireference/#SDDP.parameterize"><code>SDDP.parameterize</code></a> can only be called once in each subproblem definition!</p></div></div><h2 id="Training-and-simulating-the-policy"><a class="docs-heading-anchor" href="#Training-and-simulating-the-policy">Training and simulating the policy</a><a id="Training-and-simulating-the-policy-1"></a><a class="docs-heading-anchor-permalink" href="#Training-and-simulating-the-policy" title="Permalink"></a></h2><p>As in <a href="../01_first_steps/#Basic-I:-first-steps">Basic I: first steps</a>, we train the policy:</p><pre><code class="language-julia">SDDP.train(model; iteration_limit = 10)</code></pre><pre><code class="language-none">------------------------------------------------------------------------------
                      SDDP.jl (c) Oscar Dowson, 2017-21

Numerical stability report
  Non-zero Matrix range     [1e+00, 1e+00]
  Non-zero Objective range  [1e+00, 2e+02]
  Non-zero Bounds range     [2e+02, 2e+02]
  Non-zero RHS range        [2e+02, 2e+02]
No problems detected

Solver: serial mode

 Iteration    Simulation       Bound         Time (s)    Proc. ID   # Solves
        1    1.500000e+04   5.000000e+03   1.864910e-03          1         12
        2    7.500000e+03   8.333333e+03   2.278090e-03          1         24
        3    8.750000e+03   8.333333e+03   2.654076e-03          1         36
        4    7.500000e+03   8.333333e+03   3.009081e-03          1         48
        5    7.500000e+03   8.333333e+03   3.467083e-03          1         60
        6    2.500000e+03   8.333333e+03   4.343987e-03          1         72
        7    5.000000e+03   8.333333e+03   4.773140e-03          1         84
        8    2.000000e+04   8.333333e+03   5.167961e-03          1         96
        9    5.000000e+03   8.333333e+03   5.562067e-03          1        108
       10    5.000000e+03   8.333333e+03   5.952120e-03          1        120

Terminating training with status: iteration_limit
------------------------------------------------------------------------------
</code></pre><p>We can also simulate the policy. Note that this time, the simulation is stochastic. One common approach to quantify the quality of the policy is to perform  a Monte Carlo simulation and then form a confidence interval for the expected cost. This confidence interval is an estimate for the upper bound.</p><p>In addition to the confidence interval, we can calculate the lower bound using <a href="../../apireference/#SDDP.calculate_bound"><code>SDDP.calculate_bound</code></a>.</p><pre><code class="language-julia">using Statistics

simulations = SDDP.simulate(model, 500)

objective_values = [
    sum(stage[:stage_objective] for stage in sim) for sim in simulations
]

μ = round(mean(objective_values), digits = 2)

ci = round(1.96 * std(objective_values) / sqrt(500), digits = 2)

println(&quot;Confidence interval: &quot;, μ, &quot; ± &quot;, ci)
println(&quot;Lower bound: &quot;, round(SDDP.calculate_bound(model), digits = 2))</code></pre><pre><code class="language-none">Confidence interval: 8360.0 ± 412.58
Lower bound: 8333.33
</code></pre><p>In addition to simulating the primal values of variables, we can also pass <code>SDDP.jl</code> custom recorder functions. Each of these functions takes one argument, the JuMP subproblem, and returns anything you can compute. For example, the dual of the demand constraint (which we named <code>demand_constraint</code>) corresponds to the price we should charge for electricity, since it represents the cost of each additional unit of demand. To calculate this, we can go</p><pre><code class="language-julia">simulations = SDDP.simulate(
    model,
    1,
    custom_recorders = Dict{Symbol, Function}(
        :price =&gt; (sp) -&gt; JuMP.dual(sp[:demand_constraint])
    )
)

prices = [stage[:price] for stage in simulations[1]]</code></pre><pre><code class="language-none">3-element Array{Float64,1}:
  50.0
 100.0
 150.0</code></pre><p>This concludes our second tutorial for <code>SDDP.jl</code>. In the next tutorial, <a href="../03_objective_uncertainty/#Basic-III:-objective-uncertainty">Basic III: objective uncertainty</a>, we extend the uncertainty to the fuel cost.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../01_first_steps/">« Basic I: first steps</a><a class="docs-footer-nextpage" href="../03_objective_uncertainty/">Basic III: objective uncertainty »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Friday 8 January 2021 07:17">Friday 8 January 2021</span>. Using Julia version 1.0.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
