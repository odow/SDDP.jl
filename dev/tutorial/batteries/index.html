<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Example: batteries · SDDP.jl</title><meta name="title" content="Example: batteries · SDDP.jl"/><meta property="og:title" content="Example: batteries · SDDP.jl"/><meta property="twitter:title" content="Example: batteries · SDDP.jl"/><meta name="description" content="Documentation for SDDP.jl."/><meta property="og:description" content="Documentation for SDDP.jl."/><meta property="twitter:description" content="Documentation for SDDP.jl."/><script async src="https://www.googletagmanager.com/gtag/js?id=G-HZQQDVMPZW"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HZQQDVMPZW', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="SDDP.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../first_steps/">An introduction to SDDP.jl</a></li><li><a class="tocitem" href="../objective_uncertainty/">Uncertainty in the objective function</a></li><li><a class="tocitem" href="../markov_uncertainty/">Markovian policy graphs</a></li><li><a class="tocitem" href="../plotting/">Plotting tools</a></li><li><a class="tocitem" href="../warnings/">Words of warning</a></li><li><a class="tocitem" href="../arma/">Auto-regressive stochastic processes</a></li><li><a class="tocitem" href="../decision_hazard/">Here-and-now and hazard-decision</a></li><li><a class="tocitem" href="../objective_states/">Objective states</a></li><li><a class="tocitem" href="../pglib_opf/">Alternative forward models</a></li><li><a class="tocitem" href="../mdps/">Example: Markov Decision Processes</a></li><li><a class="tocitem" href="../example_newsvendor/">Example: two-stage newsvendor</a></li><li><a class="tocitem" href="../example_reservoir/">Example: deterministic to stochastic</a></li><li><a class="tocitem" href="../example_milk_producer/">Example: the milk producer</a></li><li><a class="tocitem" href="../inventory/">Example: inventory management</a></li><li class="is-active"><a class="tocitem" href>Example: batteries</a><ul class="internal"><li><a class="tocitem" href="#Packages"><span>Packages</span></a></li><li><a class="tocitem" href="#The-model"><span>The model</span></a></li><li><a class="tocitem" href="#Training"><span>Training</span></a></li><li><a class="tocitem" href="#Analyzing-the-solution"><span>Analyzing the solution</span></a></li><li><a class="tocitem" href="#Next-steps"><span>Next steps</span></a></li></ul></li><li><a class="tocitem" href="../duality_handlers/">Duality handlers</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">How-to guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../guides/use_multithreading/">Use multithreading</a></li><li><a class="tocitem" href="../../guides/access_previous_variables/">Access variables from a previous stage</a></li><li><a class="tocitem" href="../../guides/add_a_multidimensional_state_variable/">Add a multi-dimensional state variable</a></li><li><a class="tocitem" href="../../guides/add_a_risk_measure/">Add a risk measure</a></li><li><a class="tocitem" href="../../guides/add_integrality/">Integrality</a></li><li><a class="tocitem" href="../../guides/add_multidimensional_noise/">Add multi-dimensional noise terms</a></li><li><a class="tocitem" href="../../guides/add_noise_in_the_constraint_matrix/">Add noise in the constraint matrix</a></li><li><a class="tocitem" href="../../guides/choose_a_stopping_rule/">Choose a stopping rule</a></li><li><a class="tocitem" href="../../guides/create_a_general_policy_graph/">Create a general policy graph</a></li><li><a class="tocitem" href="../../guides/add_a_custom_cut/">Add a custom cut</a></li><li><a class="tocitem" href="../../guides/debug_a_model/">Debug a model</a></li><li><a class="tocitem" href="../../guides/improve_computational_performance/">Improve computational performance</a></li><li><a class="tocitem" href="../../guides/simulate_using_a_different_sampling_scheme/">Simulate using a different sampling scheme</a></li><li><a class="tocitem" href="../../guides/create_a_belief_state/">Create a belief state</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Explanation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/theory_intro/">Introductory theory</a></li><li><a class="tocitem" href="../../explanation/risk/">Risk aversion</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/FAST_hydro_thermal/">FAST: the hydro-thermal problem</a></li><li><a class="tocitem" href="../../examples/FAST_production_management/">FAST: the production management problem</a></li><li><a class="tocitem" href="../../examples/FAST_quickstart/">FAST: the quickstart problem</a></li><li><a class="tocitem" href="../../examples/Hydro_thermal/">Hydro-thermal scheduling</a></li><li><a class="tocitem" href="../../examples/StochDynamicProgramming.jl_multistock/">StochDynamicProgramming: the multistock problem</a></li><li><a class="tocitem" href="../../examples/StochDynamicProgramming.jl_stock/">StochDynamicProgramming: the stock problem</a></li><li><a class="tocitem" href="../../examples/StructDualDynProg.jl_prob5.2_2stages/">StructDualDynProg: Problem 5.2, 2 stages</a></li><li><a class="tocitem" href="../../examples/StructDualDynProg.jl_prob5.2_3stages/">StructDualDynProg: Problem 5.2, 3 stages</a></li><li><a class="tocitem" href="../../examples/agriculture_mccardle_farm/">The farm planning problem</a></li><li><a class="tocitem" href="../../examples/air_conditioning/">Air conditioning</a></li><li><a class="tocitem" href="../../examples/air_conditioning_forward/">Training with a different forward model</a></li><li><a class="tocitem" href="../../examples/all_blacks/">Deterministic All Blacks</a></li><li><a class="tocitem" href="../../examples/asset_management_simple/">Asset management</a></li><li><a class="tocitem" href="../../examples/asset_management_stagewise/">Asset management with modifications</a></li><li><a class="tocitem" href="../../examples/belief/">Partially observable inventory management</a></li><li><a class="tocitem" href="../../examples/biobjective_hydro/">Biobjective hydro-thermal</a></li><li><a class="tocitem" href="../../examples/booking_management/">Booking management</a></li><li><a class="tocitem" href="../../examples/generation_expansion/">Generation expansion</a></li><li><a class="tocitem" href="../../examples/hydro_valley/">Hydro valleys</a></li><li><a class="tocitem" href="../../examples/infinite_horizon_hydro_thermal/">Infinite horizon hydro-thermal</a></li><li><a class="tocitem" href="../../examples/infinite_horizon_trivial/">Infinite horizon trivial</a></li><li><a class="tocitem" href="../../examples/inner_hydro_1d/">Hydro-thermal with inner approximation</a></li><li><a class="tocitem" href="../../examples/no_strong_duality/">No strong duality</a></li><li><a class="tocitem" href="../../examples/objective_state_newsvendor/">Newsvendor</a></li><li><a class="tocitem" href="../../examples/sldp_example_one/">SLDP: example 1</a></li><li><a class="tocitem" href="../../examples/sldp_example_two/">SLDP: example 2</a></li><li><a class="tocitem" href="../../examples/stochastic_all_blacks/">Stochastic All Blacks</a></li><li><a class="tocitem" href="../../examples/the_farmers_problem/">The farmer&#39;s problem</a></li><li><a class="tocitem" href="../../examples/vehicle_location/">Vehicle location</a></li></ul></li><li><a class="tocitem" href="../../apireference/">API Reference</a></li><li><a class="tocitem" href="../../release_notes/">Release notes</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Example: batteries</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Example: batteries</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/odow/SDDP.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/odow/SDDP.jl/blob/master/docs/src/tutorial/batteries.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Example:-batteries"><a class="docs-heading-anchor" href="#Example:-batteries">Example: batteries</a><a id="Example:-batteries-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-batteries" title="Permalink"></a></h1><p><em>This tutorial was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em> <a href="../batteries.jl"><em>Download the source as a <code>.jl</code> file</em></a>. <a href="../batteries.ipynb"><em>Download the source as a <code>.ipynb</code> file</em></a>.</p><p>The purpose of this tutorial is to demonstrate how to model the operation of a battery in power system with uncertain load.</p><p>This example was originally developed by Andy Philpott as part of the Winter School Kvitfjell 2025, <em>Planning Under Uncertainty in Energy Markets</em>, organized by NORDAB - The Norwegian Doctoral Academy in Business.</p><h2 id="Packages"><a class="docs-heading-anchor" href="#Packages">Packages</a><a id="Packages-1"></a><a class="docs-heading-anchor-permalink" href="#Packages" title="Permalink"></a></h2><p>This tutorial requires the following packages:</p><pre><code class="language-julia hljs">using SDDP
import HiGHS
import Plots</code></pre><h2 id="The-model"><a class="docs-heading-anchor" href="#The-model">The model</a><a id="The-model-1"></a><a class="docs-heading-anchor-permalink" href="#The-model" title="Permalink"></a></h2><p>Our model is a day in the life of a simple power system with one thermal generator and one battery. There are 24 hourly stages that form a linear policy graph.</p><p>There are two state variables: <code>x_soc</code>, the state-of-charge of the battery; and <code>x_thermal</code>, the output of the thermal generator.</p><p>There are four control variables: <code>u_charge</code> and <code>u_discharge</code> for charging and discharging the battery in each stage, and <code>u_slack</code> and <code>u_surplus</code> for measuring the slack and surplus energy generation.</p><p>There is one random variable: <code>w_load</code>, which is the energy load of the system in each stage.</p><p>The objective is to minimize cost, which is comprised of the cost of thermal generation and the value of lost-load (<code>u_slack</code>).</p><p>There are three constraints: a balance on the state-of-charge of the battery, which accounts for charging inefficiency; ramping limits on the thermal generator; and an energy balance constraint on the energy produced.</p><p>Here&#39;s the model in SDDP.jl:</p><pre><code class="language-julia hljs">model = SDDP.LinearPolicyGraph(;
    stages = 24,
    sense = :Min,
    lower_bound = 0.0,
    optimizer = HiGHS.Optimizer,
) do sp, t
    # State variables
    @variable(sp, 0 &lt;= x_soc &lt;= 30, SDDP.State, initial_value = 4)
    @variable(sp, 0 &lt;= x_thermal &lt;= 70, SDDP.State, initial_value = 35)
    # Control variables
    @variable(sp, 0 &lt;= u_charge &lt;= 15)
    @variable(sp, 0 &lt;= u_discharge &lt;= 15)
    @variable(sp, u_slack &gt;= 0)
    @variable(sp, u_surplus &gt;= 0)
    # Random variables
    @variable(sp, w_load)
    Ω = [-4.0, -2.0, 0.0, 2.0, 4.0]
    d = vcat(
        [40, 41, 42, 43, 35, 40, 40, 25, 10, 8, 6, 5],  # Hours 01-12
        [5, 6, 8, 10, 20, 30, 55, 72, 75, 70, 64, 60],  # Hours 13-24
    )
    SDDP.parameterize(ω -&gt; JuMP.fix(w_load, d[t] + ω), sp, Ω)
    # Objective function
    @stageobjective(sp, 70 * x_thermal.out + 500 * u_slack)
    # Constraints
    @constraint(sp, x_soc.out == x_soc.in + 0.8 * u_charge - u_discharge)
    @constraint(sp, x_thermal.out - x_thermal.in &lt;= 10)
    @constraint(
        sp,
        λ,
        x_thermal.out + u_discharge - u_charge + u_slack == w_load + u_surplus,
    )
    return
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">A policy graph with 24 nodes.
 Node indices: 1, ..., 24
</code></pre><h2 id="Training"><a class="docs-heading-anchor" href="#Training">Training</a><a id="Training-1"></a><a class="docs-heading-anchor-permalink" href="#Training" title="Permalink"></a></h2><p>We train the model for 500 iterations using the <a href="../../apireference/#SDDP.Threaded"><code>SDDP.Threaded</code></a> parallel scheme.</p><pre><code class="language-julia hljs">SDDP.train(model; iteration_limit = 500, parallel_scheme = SDDP.Threaded())

results = SDDP.simulate(
    model,
    100,
    [:x_soc, :x_thermal, :u_slack, :w_load];
    custom_recorders = Dict{Symbol,Function}(:λ =&gt; sp -&gt; JuMP.dual(sp[:λ])),
);</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">-------------------------------------------------------------------
         SDDP.jl (c) Oscar Dowson and contributors, 2017-25
-------------------------------------------------------------------
problem
  nodes           : 24
  state variables : 2
  scenarios       : 5.96046e+16
  existing cuts   : false
options
  solver          : Threaded()
  risk measure    : SDDP.Expectation()
  sampling scheme : SDDP.InSampleMonteCarlo
subproblem structure
  VariableRef                             : [10, 10]
  AffExpr in MOI.EqualTo{Float64}         : [2, 2]
  AffExpr in MOI.LessThan{Float64}        : [1, 1]
  VariableRef in MOI.GreaterThan{Float64} : [7, 7]
  VariableRef in MOI.LessThan{Float64}    : [4, 5]
numerical stability report
  matrix range     [8e-01, 1e+00]
  objective range  [1e+00, 5e+02]
  bounds range     [2e+01, 7e+01]
  rhs range        [1e+01, 1e+01]
-------------------------------------------------------------------
 iteration    simulation      bound        time (s)     solves  pid
-------------------------------------------------------------------
         1   8.610000e+04  2.521192e+04  1.195869e-01       536   3
       181   5.594400e+04  5.712756e+04  1.121513e+00     26225   3
       314   5.710310e+04  5.712841e+04  2.127908e+00     45400   2
       422   5.719807e+04  5.712852e+04  3.134901e+00     60975   2
       482   5.656000e+04  5.712856e+04  4.146050e+00     69591   5
       503   5.689600e+04  5.712856e+04  4.402381e+00     72432   3
-------------------------------------------------------------------
status         : iteration_limit
total time (s) : 4.402381e+00
total solves   : 72432
best bound     :  5.712856e+04
simulation ci  :  5.742681e+04 ± 2.558101e+02
numeric issues : 0
-------------------------------------------------------------------</code></pre><h2 id="Analyzing-the-solution"><a class="docs-heading-anchor" href="#Analyzing-the-solution">Analyzing the solution</a><a id="Analyzing-the-solution-1"></a><a class="docs-heading-anchor-permalink" href="#Analyzing-the-solution" title="Permalink"></a></h2><p>The load follows the classic &quot;duck curve&quot;. There are two defining features: large amounts of solar during the middle of the day reduce the net load to form the belly of the duck, and the drop in solar combined with high gross load in the evening forms a steep ramp along the neck of the duck.</p><pre><code class="language-julia hljs">SDDP.publication_plot(results; xlabel = &quot;Hour&quot;, ylabel = &quot;Net load&quot;) do d
    return d[:w_load]
end</code></pre><img src="ffea718c.svg" alt="Example block output"/><p>Thermal generation mostly follows net load, except the thermal generation is limited by the ramp up constraints during the afternoon as the generator increases to reach maximum production during the 21 hour:</p><pre><code class="language-julia hljs">SDDP.publication_plot(
    results;
    xlabel = &quot;Hour&quot;,
    ylabel = &quot;Thermal generation&quot;,
) do d
    return d[:x_thermal].out
end</code></pre><img src="477d23cc.svg" alt="Example block output"/><p>The battery starts with 4 units of charge, empties it during the 10th hour, charges during the afternoon, and then discharges during the evening peak. Because we have modeled a finite horizon problem with no terminal value function, the battery ends the 24th hour with an empty state of charge.</p><pre><code class="language-julia hljs">SDDP.publication_plot(results; xlabel = &quot;Hour&quot;, ylabel = &quot;State of charge&quot;) do d
    return d[:x_soc].out
end</code></pre><img src="be3b4a9a.svg" alt="Example block output"/><p>The batteries charging decisions are driven by the dual value of the <code>demand_constraint</code> which can be interpreted as the price of energy. During the first part of the day, the price of energy is <span>$</span>70/unit, which is the fuel price of the thermal generator. During the afternoon, the price decreases below the fuel price, and the battery arbitrages this difference by charging. The peak price is incurred during the evening, when the price sometimes spikes to <span>$</span>500/unit, which is the value of lost load (VOLL).</p><pre><code class="language-julia hljs">SDDP.publication_plot(results; xlabel = &quot;Hour&quot;, ylabel = &quot;Dual λ&quot;) do d
    return d[:λ]
end</code></pre><img src="7de05f17.svg" alt="Example block output"/><p>The <code>u_slack</code> variable is the lost load:</p><pre><code class="language-julia hljs">SDDP.publication_plot(results; xlabel = &quot;Hour&quot;, ylabel = &quot;Lost load&quot;) do d
    return d[:u_slack]
end</code></pre><img src="41109c18.svg" alt="Example block output"/><h2 id="Next-steps"><a class="docs-heading-anchor" href="#Next-steps">Next steps</a><a id="Next-steps-1"></a><a class="docs-heading-anchor-permalink" href="#Next-steps" title="Permalink"></a></h2><p>Can you use the information in the previous plots to explain why the energy price falls below the fuel cost?</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../inventory/">« Example: inventory management</a><a class="docs-footer-nextpage" href="../duality_handlers/">Duality handlers »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Tuesday 4 November 2025 22:58">Tuesday 4 November 2025</span>. Using Julia version 1.12.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
